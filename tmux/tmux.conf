# Prefer C-a binding over C-b.
set-option -g prefix C-a

# Allow use of native C-a via C-a a.
bind-key a send-prefix

# Fix "returned 127" error
# https://github.com/tmux-plugins/tpm/blob/master/docs/tpm_not_working.md
if-shell '[ $(uname -p) == 'arm' ]' \
	'set-environment -g PATH "/opt/homebrew/bin:/usr/bin"' \
	'set-environment -g PATH "/usr/local/bin:/bin:/usr/bin"'

# Use fish as interactive shell.
if-shell '[ $(uname -p) == 'arm' ]' \
	'set-option -g default-shell "/opt/homebrew/bin/fish"' \
	'set-option -g default-shell "/usr/local/bin/fish"'

# Decrease escape timeout.
#
# See:
# https://github.com/neovim/neovim/wiki/FAQ#esc-in-tmux-or-gnu-screen-is-delayed
set -sg escape-time 10

# Set correct $TERM value.
# NB: tmux-256color is not included in terminfo on macOS by default, so
# screen-256color is used instead.
#
# See:
# https://github.com/neovim/neovim/wiki/FAQ#colors-arent-displayed-correctly
set -g default-terminal "tmux-256color"

# Set RGB compatibility per advice given by Neovim's `:checkhealth` command.
set -sa terminal-overrides ',xterm-256color:RGB'

# Pass through window titles to terminal.
set -g set-titles on
set -g set-titles-string '#W'

# Start numbering at 1 and automatically name.
set -g allow-rename off
set -g base-index 1
set -g renumber-windows on
setw -g automatic-rename on

# Enable mouse support.
set -g mouse on

# Enable vi mode.
set-window-option -g mode-keys vi

# Smart pane switching with awareness of Vim splits.
# From https://github.com/aserowy/tmux.nvim#navigation
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' { if -F '#{pane_at_left}' '' 'select-pane -L' }
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' { if -F '#{pane_at_top}' '' 'select-pane -U' }
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' { if -F '#{pane_at_right}' '' 'select-pane -R' }

bind-key -T copy-mode-vi 'C-h' if -F '#{pane_at_left}' '' 'select-pane -L'
bind-key -T copy-mode-vi 'C-j' if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind-key -T copy-mode-vi 'C-k' if -F '#{pane_at_top}' '' 'select-pane -U'
bind-key -T copy-mode-vi 'C-l' if -F '#{pane_at_right}' '' 'select-pane -R'

# bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'run "tmux-yabai.sh west"'
# bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'run "tmux-yabai.sh south"'
# bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'run "tmux-yabai.sh north"'
# bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'run "tmux-yabai.sh east"'

# Moving windows
bind-key -n 'C-S-Left' swap-window -t -1
bind-key -n 'C-S-Right' swap-window -t +1

# Smart pane killing
bind-key d run-shell "~/.config/tmux/sh/smart-kill-pane"

# Split panes with v and h
bind-key v split-window -h
bind-key s split-window -v

# Use C-a o to display panes
bind-key o display-panes

# Use C-a z to suspend
bind-key z detach

# Use C-a Â´ to switch to last active window.
bind-key Â´ last-window

# Status line foreground color
set -g status-fg colour8

# Status line background color
set -g status-bg colour235

# Clock color
set-window-option -g clock-mode-colour colour4

# Command style
set -g message-style bg=0
set -g message-command-style bg=0
set -g mode-style bg=0

# Status line current window's foreground color is different
set-window-option -g window-status-current-style fg=colour4

# Pane border color
set -g pane-active-border-style fg=colour4

# Minimal bar
set -g status-justify centre
set -g status-left "        "
set -g status-right "#{?client_prefix,    [ðŸ‘€],[#S]}"
set -g status-right-style fg=colour2

# Status bar on the top
set-option -g status-position top

# Plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'

if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm/tpm'"
run '~/.config/tmux/plugins/tpm/tpm'
